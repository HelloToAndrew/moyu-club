<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Moyu Club - ç™»å…¥</title>

  <style>
    body {
      background: #f2f6ff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      width: 380px;
      background: #ffffff;
      padding: 24px 28px 28px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    h2 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 22px;
      text-align: center;
    }
    p.sub {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 13px;
      color: #666;
      text-align: center;
    }
    label {
      font-size: 13px;
      color: #444;
      display: block;
      margin-bottom: 4px;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d0d7e2;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74,144,226,0.18);
    }
    button.primary {
      width: 100%;
      padding: 10px 0;
      margin-top: 14px;
      border: none;
      border-radius: 10px;
      background: #4a90e2;
      color: white;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary[disabled] {
      opacity: 0.6;
      cursor: default;
    }
    button.primary:hover:not([disabled]) {
      background: #3578c8;
    }
    .row-links {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 13px;
    }
    .link {
      color: #4a90e2;
      cursor: pointer;
    }
    .link:hover {
      text-decoration: underline;
    }
    .divider {
      display: flex;
      align-items: center;
      margin: 18px 0 12px;
      font-size: 12px;
      color: #999;
    }
    .divider span {
      flex: 1;
      height: 1px;
      background: #e0e4ef;
    }
    .divider b {
      margin: 0 8px;
      font-weight: 400;
      white-space: nowrap;
    }
    button.google {
      width: 100%;
      padding: 9px 0;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button.google img {
      width: 18px;
      height: 18px;
    }
    #status {
      margin-top: 10px;
      font-size: 12px;
      color: #888;
      text-align: center;
      min-height: 16px;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      sendPasswordResetEmail,
      signOut,
      reload
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4oaUyo3RWJnnLLN3CkiiJ8wimp_43kko",
      authDomain: "moyu-club.firebaseapp.com",
      projectId: "moyu-club",
      storageBucket: "moyu-club.firebasestorage.app",
      messagingSenderId: "178708686787",
      appId: "1:178708686787:web:be7c38dfe3d29a6695bf76",
      measurementId: "G-GPV3CMCZ0T"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    function setStatus(msg) {
      const el = document.getElementById("status");
      if (el) el.textContent = msg || "";
    }

    function setLoading(loading) {
      const btn = document.getElementById("btnEmailLogin");
      if (!btn) return;
      btn.disabled = loading;
      btn.textContent = loading ? "ç™»å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦" : "ä»¥ Email ç™»å…¥";
    }

    // ğŸ…° Email ç™»å…¥ï¼ˆåŒæ™‚çœ‹ emailVerified èˆ‡ Firestore.verifiedï¼‰
    window.loginWithEmail = async () => {
      const email = document.getElementById("email").value.trim();
      const pw    = document.getElementById("password").value;

      if (!email || !pw) {
        alert("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");
        return;
      }

      try {
        setLoading(true);
        setStatus("ç™»å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦");

        const cred = await signInWithEmailAndPassword(auth, email, pw);
        const user = cred.user;
        await reload(user); // æ›´æ–° emailVerified ç‹€æ…‹

        const userRef = doc(db, "users", user.uid);
        let snap = await getDoc(userRef);
        let data = snap.exists() ? snap.data() : null;

        // ğŸ”‘ é—œéµé‚è¼¯ï¼šå…©è€…éƒ½æ²’éæ‰æ“‹
        const emailOk    = !!user.emailVerified;
        const firestoreOk = !!(data && data.verified);

        if (!emailOk && !firestoreOk) {
          await signOut(auth);
          setLoading(false);
          setStatus("");
          alert("Email å°šæœªå®Œæˆé©—è­‰ï¼Œè«‹å…ˆåˆ°ä¿¡ç®±é»é©—è­‰é€£çµã€‚");
          return;
        }

        // è‹¥ Firestore é‚„æ²’å»ºç«‹ / é‚„æ²’æ¨™è¨˜ verifiedï¼Œå°±é †æ‰‹è£œä¸Š
        if (!snap.exists()) {
          await setDoc(userRef, {
            email: user.email || email,
            nickname: "",
            createdAt: new Date().toISOString(),
            verified: emailOk || firestoreOk
          });
        } else if (!data.verified && emailOk) {
          await setDoc(userRef, { verified: true }, { merge: true });
        }

        setStatus("ç™»å…¥æˆåŠŸï¼Œå‰å¾€ä¸»ç•«é¢â€¦");
        snap = await getDoc(userRef);
        data = snap.data() || {};

        if (data.nickname && data.nickname.trim() !== "") {
          window.location.href = "home.html";
        } else {
          window.location.href = "nickname.html";
        }

      } catch (err) {
        console.error("Email ç™»å…¥éŒ¯èª¤ï¼š", err);
        alert("ç™»å…¥å¤±æ•—ï¼š" + err.code);
        setLoading(false);
        setStatus("");
      }
    };

    // ğŸ…± Google ç™»å…¥ï¼šä¸€å¾‹ç•¶ verified = true
    window.loginWithGoogle = async () => {
      try {
        setStatus("ä½¿ç”¨ Google ç™»å…¥ä¸­â€¦");
        const provider = new GoogleAuthProvider();
        const result   = await signInWithPopup(auth, provider);
        const user     = result.user;

        const userRef = doc(db, "users", user.uid);
        let snap = await getDoc(userRef);
        let data = snap.exists() ? snap.data() : null;

        if (!snap.exists()) {
          await setDoc(userRef, {
            email: user.email || "",
            nickname: "",
            createdAt: new Date().toISOString(),
            provider: "google",
            verified: true
          });
        } else if (!data.verified) {
          await setDoc(userRef, { verified: true }, { merge: true });
        }

        setStatus("ç™»å…¥æˆåŠŸï¼Œå‰å¾€ä¸»ç•«é¢â€¦");
        snap = await getDoc(userRef);
        data = snap.data() || {};

        if (data.nickname && data.nickname.trim() !== "") {
          window.location.href = "home.html";
        } else {
          window.location.href = "nickname.html";
        }

      } catch (err) {
        console.error("Google ç™»å…¥éŒ¯èª¤ï¼š", err);
        alert("Google ç™»å…¥å¤±æ•—ï¼š" + err.code);
        setStatus("");
      }
    };

    // å¿˜è¨˜å¯†ç¢¼
    window.goReset = () => {
      window.location.href = "reset.html";
    };

    // è¨»å†Š
    window.goRegister = () => {
      window.location.href = "register.html";
    };
  </script>
</head>
<body>
  <div class="card">
    <h2>Moyu Club</h2>
    <p class="sub">ç™»å…¥å¾Œï¼Œé–‹å§‹ä»Šå¤©çš„æ‘¸é­šé…å° ğŸŸ</p>

    <label for="email">Email</label>
    <input id="email" type="email" autocomplete="email" />

    <label for="password">å¯†ç¢¼</label>
    <input id="password" type="password" autocomplete="current-password" />

    <button id="btnEmailLogin" class="primary" onclick="loginWithEmail()">
      ä»¥ Email ç™»å…¥
    </button>

    <div class="row-links">
      <span class="link" onclick="goReset()">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</span>
      <span class="link" onclick="goRegister()">è¨»å†Šæ–°å¸³è™Ÿ</span>
    </div>

    <div class="divider">
      <span></span><b>æˆ– ä½¿ç”¨å…¶ä»–æ–¹å¼</b><span></span>
    </div>

    <button class="google" onclick="loginWithGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" />
      ä½¿ç”¨ Google ç™»å…¥
    </button>

    <div id="status"></div>
  </div>
</body>
</html>
