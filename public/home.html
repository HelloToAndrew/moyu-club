<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Moyu Club - ä¸»ç•«é¢</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f2f6ff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .shell {
      width: 900px;
      max-width: 100%;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.08);
      padding: 20px 24px 18px;
      box-sizing: border-box;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .logo-title {
      font-size: 20px;
      font-weight: 600;
    }
    .user-area {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f0f4ff;
      color: #3755a3;
      font-size: 12px;
    }
    .btn-link {
      border: none;
      background: transparent;
      cursor: pointer;
      color: #4a90e2;
      font-size: 13px;
      padding: 4px 8px;
    }
    .btn-link:disabled {
      color: #aaa;
      cursor: default;
    }
    .btn-link:hover:not(:disabled) {
      text-decoration: underline;
    }
    .main {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 16px;
      margin-top: 8px;
    }
    .panel {
      background: #f8f9ff;
      border-radius: 14px;
      padding: 14px 16px;
      box-sizing: border-box;
      height: 360px;
      display: flex;
      flex-direction: column;
    }
    .panel h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .status-text {
      font-size: 14px;
      color: #555;
      min-height: 20px;
      margin-bottom: 8px;
    }
    .big-number {
      font-size: 26px;
      font-weight: 600;
      color: #4a90e2;
      margin: 8px 0 4px;
    }
    .hint {
      font-size: 12px;
      color: #888;
      margin-bottom: 12px;
    }
    .btn-main {
      border: none;
      border-radius: 10px;
      background: #4a90e2;
      color: #fff;
      padding: 10px 0;
      font-size: 15px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .btn-main[disabled] {
      opacity: 0.6;
      cursor: default;
    }
    .btn-main:hover:not([disabled]) {
      background: #3578c8;
    }
    .timer {
      font-size: 14px;
      color: #333;
      margin-top: 4px;
    }
    .keep-row {
      margin-top: auto;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      display: none; /* âœ… ä¸€é–‹å§‹ä¸é¡¯ç¤ºï¼Œæ™‚é–“åˆ°å†é¡¯ç¤º */
    }
    .btn-secondary, .btn-danger {
      border-radius: 8px;
      border: none;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-secondary {
      background: #ffffff;
      border: 1px solid #d0d7e2;
      color: #36528f;
    }
    .btn-danger {
      background: #ff6b6b;
      color: #fff;
    }
    .btn-secondary[disabled],
    .btn-danger[disabled] {
      opacity: 0.5;
      cursor: default;
    }

    /* èŠå¤©å€ */
    .chat-log {
      flex: 1;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e1e4f0;
      padding: 10px;
      font-size: 13px;
      overflow-y: auto;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }
    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }
    .chat-input-row input {
      flex: 1;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #ccd2e1;
      box-sizing: border-box;
    }
    .chat-input-row button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: #4a90e2;
      color: white;
      cursor: pointer;
      font-size: 13px;
    }
    .chat-input-row button:hover:not([disabled]) {
      background: #3578c8;
    }
    .chat-input-row button[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    .system-msg {
      color: #888;
    }
    .me-msg {
      color: #2f7d32;
    }
    .partner-msg {
      color: #333;
    }

    /* å·²ä¿ç•™ç·£åˆ†åˆ—è¡¨ */
    .saved-section {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed #d0d7e2;
    }
    .saved-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .saved-header h3 {
      font-size: 14px;
      margin: 0;
    }
    .saved-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .saved-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9ff;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 13px;
    }
    .saved-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .saved-label {
      font-weight: 500;
    }
    .saved-time {
      font-size: 11px;
      color: #777;
    }
    .saved-actions {
      display: flex;
      gap: 6px;
    }
    .saved-actions button {
      border-radius: 8px;
      border: none;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn-chat-again {
      background: #4a90e2;
      color: #fff;
    }
    .btn-delete {
      background: #ffffff;
      border: 1px solid #d0d7e2;
      color: #555;
    }
    .saved-hint {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="top-bar">
      <div class="logo-title">Moyu Club ğŸŸ</div>
      <div class="user-area">
        <span id="nicknameBadge" class="badge">æš±ç¨±è¼‰å…¥ä¸­â€¦</span>
        <button class="btn-link" id="btnAccount">å¸³è™Ÿè¨­å®š</button>
        <button class="btn-link" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="main">
      <!-- å·¦å´ï¼šé…å°èˆ‡ç‹€æ…‹ -->
      <div class="panel">
        <h3>ä»Šæ—¥æ‘¸é­šç‹€æ…‹</h3>
        <div class="status-text" id="statusText">å°šæœªé–‹å§‹é…å°</div>
        <div class="big-number" id="timerText">â€” : â€”</div>
        <div class="hint">
          æŒ‰ä¸‹ã€Œé–‹å§‹é…å°ã€å¾Œï¼Œå¯ä»¥ç¹¼çºŒå·¥ä½œã€‚é…å°æˆåŠŸæœƒåœ¨é€™è£¡æé†’ä½ ã€‚
        </div>

        <button class="btn-main" id="btnMatch">é–‹å§‹é…å°</button>

        <div class="timer" id="matchInfo">ç›®å‰ç·šä¸Šæ‚ éŠä¸­çš„é­šï¼š--</div>

        <div class="keep-row" id="keepRow">
          <button class="btn-secondary" id="btnKeep" disabled>ä¿ç•™é€™æ®µç·£åˆ†</button>
          <button class="btn-danger" id="btnEnd" disabled>çµæŸå°è©±</button>
        </div>
      </div>

      <!-- å³å´ï¼šèŠå¤©å€ -->
      <div class="panel">
        <h3>å°è©±çª—</h3>
        <div id="chatLog" class="chat-log">
          <div class="system-msg">å°šæœªé…å°ï¼Œè«‹å…ˆåœ¨å·¦å´æŒ‰ã€Œé–‹å§‹é…å°ã€ã€‚</div>
        </div>

        <div class="chat-input-row">
          <input id="chatInput" type="text" placeholder="æŒ‰ Enter é€å‡ºè¨Šæ¯" disabled />
          <button id="btnSend" disabled>é€å‡º</button>
        </div>
      </div>
    </div>

    <!-- å·²ä¿ç•™ç·£åˆ†æ¸…å–® -->
    <div class="saved-section">
      <div class="saved-header">
        <h3>å·²ä¿ç•™çš„ç·£åˆ†</h3>
        <span style="font-size: 11px; color:#999;">æœ€å¤šä¿ç•™ 3 çµ„</span>
      </div>
      <div id="savedList" class="saved-list">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
      </div>
      <div class="saved-hint" id="savedHint">
        é‚„æ²’æœ‰ä¿ç•™çš„ç·£åˆ†ã€‚æ™‚é–“åˆ°æ™‚ï¼Œå¦‚æœé›™æ–¹éƒ½æŒ‰ä¸‹ã€Œä¿ç•™é€™æ®µç·£åˆ†ã€ï¼Œå°±æœƒå‡ºç¾åœ¨é€™è£¡ã€‚
      </div>
    </div>
  </div>

  <!-- socket.io å®¢æˆ¶ç«¯ -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Firebase + ä¸»ç¨‹å¼ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4oaUyo3RWJnnLLN3CkiiJ8wimp_43kko",
      authDomain: "moyu-club.firebaseapp.com",
      projectId: "moyu-club",
      storageBucket: "moyu-club.firebasestorage.app",
      messagingSenderId: "178708686787",
      appId: "1:178708686787:web:be7c38dfe3d29a6695bf76",
      measurementId: "G-GPV3CMCZ0T"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ğŸ”§ DOM å…ƒç´ 
    const nicknameBadge   = document.getElementById("nicknameBadge");
    const statusText      = document.getElementById("statusText");
    const timerText       = document.getElementById("timerText");
    const matchInfo       = document.getElementById("matchInfo");
    const btnMatch        = document.getElementById("btnMatch");
    const btnKeep         = document.getElementById("btnKeep");
    const btnEnd          = document.getElementById("btnEnd");
    const keepRow         = document.getElementById("keepRow");
    const chatLog         = document.getElementById("chatLog");
    const chatInput       = document.getElementById("chatInput");
    const btnSend         = document.getElementById("btnSend");
    const btnAccount      = document.getElementById("btnAccount");
    const btnLogout       = document.getElementById("btnLogout");
    const savedList       = document.getElementById("savedList");
    const savedHint       = document.getElementById("savedHint");

    let currentUser = null;
    let nickname    = "åŒ¿åé­š";
    let socket      = null;
    let countdownId = null;
    let timeLeft    = 5;      // âœ… æ¸¬è©¦ç”¨ 5 ç§’
    let chatActive  = false;  // æ˜¯å¦æ­£åœ¨èŠå¤©ä¸­
    let savedMatches = [];    // å…ˆå­˜åœ¨å‰ç«¯ï¼Œä¹‹å¾Œå¯ä»¥æ¬åˆ° Firestore

    function appendMsg(text, cssClass = "system-msg") {
      const div = document.createElement("div");
      div.className = cssClass;
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function resetChatUI() {
      statusText.textContent = "å°šæœªé–‹å§‹é…å°";
      timerText.textContent  = "â€” : â€”";
      matchInfo.textContent  = "ç›®å‰ç·šä¸Šæ‚ éŠä¸­çš„é­šï¼š--";
      btnMatch.disabled = false;

      // ä¿ç•™ / çµæŸæŒ‰éˆ•æ”¶èµ·ä¾†
      keepRow.style.display = "none";
      btnKeep.disabled = true;
      btnEnd.disabled  = true;

      chatInput.disabled = true;
      btnSend.disabled   = true;
      chatInput.value    = "";
      chatLog.innerHTML  = '<div class="system-msg">å°šæœªé…å°ï¼Œè«‹å…ˆåœ¨å·¦å´æŒ‰ã€Œé–‹å§‹é…å°ã€ã€‚</div>';

      if (countdownId) {
        clearInterval(countdownId);
        countdownId = null;
      }

      chatActive = false;
      btnAccount.disabled = false;  // âœ… èŠå¤©çµæŸå¾Œæ¢å¾©å¯ä¿®æ”¹å¸³è™Ÿè¨­å®š
    }

    function startTimer() {
      if (countdownId) {
        clearInterval(countdownId);
      }
      timeLeft = 5; // âœ… æ¸¬è©¦å…ˆç”¨ 5 ç§’
      updateTimerText();
      countdownId = setInterval(() => {
        timeLeft -= 1;
        if (timeLeft <= 0) {
          clearInterval(countdownId);
          countdownId = null;
          timerText.textContent = "æ™‚é–“åˆ° ğŸ£";
          statusText.textContent = "æ™‚é–“åˆ°ï¼Œé€™æ®µç·£åˆ†è¦ä¿ç•™å—ï¼Ÿ";

          // âœ… æ™‚é–“åˆ° â†’ æ‰é¡¯ç¤ºä¿ç•™ï¼çµæŸå€åŸŸ
          keepRow.style.display = "flex";
          btnKeep.disabled = false;
          btnEnd.disabled  = false;
        } else {
          updateTimerText();
        }
      }, 1000);
    }

    function updateTimerText() {
      const m = String(Math.floor(timeLeft / 60)).padStart(2, "0");
      const s = String(timeLeft % 60).padStart(2, "0");
      timerText.textContent = `${m}:${s}`;
    }

    function renderSavedMatches() {
      savedList.innerHTML = "";
      if (savedMatches.length === 0) {
        savedHint.textContent = "é‚„æ²’æœ‰ä¿ç•™çš„ç·£åˆ†ã€‚æ™‚é–“åˆ°æ™‚ï¼Œå¦‚æœé›™æ–¹éƒ½æŒ‰ä¸‹ã€Œä¿ç•™é€™æ®µç·£åˆ†ã€ï¼Œå°±æœƒå‡ºç¾åœ¨é€™è£¡ã€‚";
        return;
      }
      savedHint.textContent = "";
      savedMatches.forEach((m, idx) => {
        const row = document.createElement("div");
        row.className = "saved-item";

        const meta = document.createElement("div");
        meta.className = "saved-meta";

        const label = document.createElement("div");
        label.className = "saved-label";
        label.textContent = m.label || `æ‘¸é­šå¤¥ä¼´ #${idx + 1}`;

        const time = document.createElement("div");
        time.className = "saved-time";
        time.textContent = "ä¿ç•™æ–¼ " + m.savedAt;

        meta.appendChild(label);
        meta.appendChild(time);

        const actions = document.createElement("div");
        actions.className = "saved-actions";

        const btnChatAgain = document.createElement("button");
        btnChatAgain.className = "btn-chat-again";
        btnChatAgain.textContent = "å†æ¬¡èŠå¤©";
        btnChatAgain.onclick = () => {
          alert("ä¹‹å¾Œæœƒåšæˆå¯ç›´æ¥é€£ä¸ŠæŒ‡å®šæˆ¿é–“ï¼Œç›®å‰å…ˆä¿ç•™ç´€éŒ„å³å¯ã€‚");
        };

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-delete";
        btnDelete.textContent = "åˆªé™¤";
        btnDelete.onclick = () => {
          savedMatches.splice(idx, 1);
          renderSavedMatches();
        };

        actions.appendChild(btnChatAgain);
        actions.appendChild(btnDelete);

        row.appendChild(meta);
        row.appendChild(actions);
        savedList.appendChild(row);
      });
    }

    function addSavedMatch(roomId) {
      if (savedMatches.length >= 3) {
        alert("ä½ å·²ç¶“ä¿ç•™äº† 3 çµ„ç·£åˆ†ï¼Œè«‹å…ˆåˆªé™¤å…¶ä¸­ä¸€çµ„å†ä¿ç•™æ–°çš„ã€‚");
        return;
      }
      savedMatches.push({
        roomId,
        label: "æ‘¸é­šå¤¥ä¼´",
        savedAt: new Date().toLocaleString()
      });
      renderSavedMatches();
    }

    function initSocket() {
      if (socket) return;

      socket = io({
        query: { nickname }
      });

      socket.on("connect", () => {
        console.log("Socket é€£ç·šæˆåŠŸï¼š", socket.id);
        matchInfo.textContent = "å·²é€£ç·šåˆ°æ‘¸é­šæ± ï¼Œç­‰å¾…ä½ é–‹å§‹é…å°ã€‚";
      });

      socket.on("status", (text) => {
        statusText.textContent = text;
      });

      socket.on("match", (text) => {
        statusText.textContent = text;
        appendMsg("ç³»çµ±ï¼š" + text, "system-msg");
        btnMatch.disabled = true;

        // å·²é…å° â†’ å¯ç«‹å³é–‹å§‹èŠå¤©
        chatInput.disabled = false;
        btnSend.disabled   = false;

        // èŠå¤©ä¸­
        chatActive = true;
        btnAccount.disabled = true;  // âœ… èŠå¤©ä¸­ä¸å¯æ”¹å¸³è™Ÿ/æš±ç¨±

        // å€’æ•¸é–‹å§‹
        keepRow.style.display = "none";
        btnKeep.disabled = true;
        btnEnd.disabled  = false;
        startTimer();
      });

      socket.on("chat", (msg) => {
        appendMsg("å°æ–¹ï¼š" + msg, "partner-msg");
      });

      // âœ… é›™æ–¹éƒ½æŒ‰ä¸‹ã€Œä¿ç•™ã€å¾Œï¼Œä¼ºæœå™¨å»£æ’­æ­¤äº‹ä»¶
      socket.on("keep-confirmed", ({ roomId }) => {
        statusText.textContent = "é€™æ®µç·£åˆ†è¢«ä½ å€‘ä¸€èµ·ä¿ç•™ä¸‹ä¾†ï¼Œå¯ä»¥æ…¢æ…¢èŠã€‚";
        appendMsg("ç³»çµ±ï¼šé›™æ–¹éƒ½é¸æ“‡ä¿ç•™ï¼Œé€™æ®µç·£åˆ†è¢«è¨˜éŒ„ä¸‹ä¾†ã€‚", "system-msg");
        timerText.textContent = "âˆ";

        // ä¸å†éœ€è¦ä¿ç•™æŒ‰éˆ•ï¼Œä½†å¯ä»¥éš¨æ™‚çµæŸ
        btnKeep.disabled = true;
        // ä½ å¯ä»¥é¸æ“‡è®“ btnEnd ä¿æŒå¯ç”¨ï¼Œè®“ä»»ä½•ä¸€æ–¹éƒ½èƒ½çµæŸå°è©±
        btnEnd.disabled  = false;

        // è¨»å†Šä¸€ç­†ä¿ç•™ç´€éŒ„
        addSavedMatch(roomId);
      });

      socket.on("chat-end", () => {
        appendMsg("ç³»çµ±ï¼šå°æ–¹å·²é›¢é–‹ï¼Œé€™æ®µç·£åˆ†å…ˆåˆ°é€™è£¡ã€‚", "system-msg");
        resetChatUI();
      });
    }

    // ğŸ§  Auth ç›£è½
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      try {
        const ref  = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};

        nickname = (data.nickname && data.nickname.trim()) || "åŒ¿åé­š";
        nicknameBadge.textContent = nickname;
        initSocket();
      } catch (err) {
        console.error("è¼‰å…¥ä½¿ç”¨è€…æš±ç¨±å¤±æ•—ï¼š", err);
        nicknameBadge.textContent = "æš±ç¨±è¼‰å…¥å¤±æ•—";
        initSocket();
      }
    });

    // ğŸ”˜ äº‹ä»¶ç¶å®š

    // é–‹å§‹é…å°
    btnMatch.addEventListener("click", () => {
      if (!socket) {
        alert("å°šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        return;
      }
      btnMatch.disabled = true;
      statusText.textContent = "é…å°ä¸­â€¦ æ­£åœ¨å°‹æ‰¾å¦ä¸€éš»é­š";
      appendMsg("ç³»çµ±ï¼šé–‹å§‹é…å°ï¼Œç­‰ä¸€ä¸‹çœ‹çœ‹æœƒæ¸¸ä¾†å“ªä¸€éš»é­šã€‚", "system-msg");
      // ç›®å‰é…å°ç”± server è‡ªå‹•å®Œæˆ
    });
    
// å…±ç”¨çš„é€å‡ºè¨Šæ¯å‡½å¼ï¼ˆæŒ‰ Enter æˆ–æŒ‰é€å‡ºæŒ‰éˆ• éƒ½æœƒèµ°åŒä¸€æ¢ï¼‰
function sendMessage() {
  const text = chatInput.value.trim();
  if (!text || !socket) return;

  socket.emit("chat", text);
  appendMsg("æˆ‘ï¼š" + text, "me-msg");

  // ğŸ”¥ğŸ”¥ğŸ”¥ æ°¸é æ¸…ç©ºï¼ˆä¸å—é…å°å‰å¾Œå½±éŸ¿ï¼‰
  chatInput.value = "";
}

// æŒ‰æŒ‰éˆ•é€å‡º
btnSend.addEventListener("click", sendMessage);

// æŒ‰ Enter é€å‡º
chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();  // ä¸è¦è§¸ç™¼æ›è¡Œ
    sendMessage();
  }
});

    // ä¿ç•™ç·£åˆ†ï¼ˆå€’æ•¸çµæŸå¾Œæ‰æŒ‰å¾—åˆ°ï¼‰
    btnKeep.addEventListener("click", () => {
      if (!socket) return;
      socket.emit("keep-request");
      statusText.textContent = "å·²é€å‡ºä¿ç•™è«‹æ±‚ï¼Œç­‰å¾…å°æ–¹å›æ‡‰â€¦";
      appendMsg("ç³»çµ±ï¼šä½ é¸æ“‡ä¿ç•™é€™æ®µç·£åˆ†ï¼Œç­‰å¾…å°æ–¹çš„é¸æ“‡ã€‚", "system-msg");
      btnKeep.disabled = true;
      // btnEnd ä¿ç•™å¯æŒ‰ï¼Œè®“ä½ ä»ç„¶å¯ä»¥çµæŸå°è©±
    });

    // çµæŸå°è©±ï¼ˆä»»ä½•æ™‚åˆ»éƒ½å¯ä»¥æŒ‰ï¼‰
    btnEnd.addEventListener("click", () => {
      if (socket) {
        socket.emit("end-chat");
      }
      appendMsg("ç³»çµ±ï¼šä½ çµæŸäº†é€™æ®µå°è©±ã€‚", "system-msg");
      resetChatUI();
    });

    // å¸³è™Ÿè¨­å®š
    btnAccount.addEventListener("click", () => {
      if (chatActive) {
        alert("ç›®å‰æ­£åœ¨èŠå¤©ä¸­ï¼Œè«‹å…ˆçµæŸå°è©±å†ä¿®æ”¹å¸³è™Ÿè¨­å®šã€‚");
        return;
      }
      window.location.href = "account.html";
    });

    // ç™»å‡º
    btnLogout.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error("ç™»å‡ºå¤±æ•—ï¼š", err);
      } finally {
        window.location.href = "login.html";
      }
    });

    // ä¸€é–‹å§‹å…ˆ reset UI
    resetChatUI();
    renderSavedMatches();
  </script>
</body>
</html>
