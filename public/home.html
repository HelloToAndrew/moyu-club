<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>MÅyu Club - ä¸»ç•«é¢</title>

    <!-- Tailwind CDNï¼ˆé–‹ç™¼ç”¨ï¼‰ -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- socket.io å®¢æˆ¶ç«¯ -->
    <script src="/socket.io/socket.io.js"></script>
  </head>

  <body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <!-- ä¸Šæ–¹åˆ—ï¼šLOGO + æš±ç¨± + ç™»å‡º -->
      <header class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-semibold tracking-tight">
            MÅyu Club ğŸŸ
          </h1>
          <p class="text-slate-400 text-sm">
            åªè®“çœŸæ­£æ‡‚ã€Œé­šçš„å¿«æ¨‚ã€çš„äººï¼Œé‡è¦‹å½¼æ­¤ã€‚
          </p>
        </div>

        <div class="flex items-center gap-3">
          <div class="text-right">
            <div class="text-sm text-slate-400">
              å—¨ï¼Œ
              <span id="nickname-text" class="font-semibold text-emerald-300"
                >...</span
              >
            </div>
            <div id="lang-text" class="text-xs text-slate-500">
              èªè¨€ï¼šä¾å¸³æˆ¶è¨­å®š
            </div>
          </div>
          <button
            id="logout-btn"
            class="text-xs px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-700"
          >
            ç™»å‡º
          </button>
        </div>
      </header>

      <main class="grid md:grid-cols-2 gap-6">
        <!-- å·¦å´ï¼šç‹€æ…‹ / éš¨æ©Ÿé…å° / å·²ä¿ç•™ç·£åˆ† -->
        <section class="space-y-4">
          <!-- ç‹€æ…‹å¡ç‰‡ -->
          <div class="bg-slate-800/70 rounded-2xl p-4 border border-slate-700">
            <h2 class="text-sm font-semibold text-slate-200 mb-2">
              ç›®å‰ç‹€æ…‹
            </h2>
            <p id="status-text" class="text-sm text-slate-300">
              æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š...
            </p>
          </div>

          <!-- éš¨æ©Ÿé…å°å¡ç‰‡ -->
          <div
            id="match-panel"
            class="bg-slate-800/70 rounded-2xl p-4 border border-slate-700"
          >
            <h2 class="text-sm font-semibold text-slate-200 mb-2">
              éš¨æ©Ÿæ‘¸é­šé…å°
            </h2>
            <p class="text-xs text-slate-400 mb-3">
              æŒ‰ä¸‹é–‹å§‹ä¹‹å¾Œï¼Œæˆ‘å€‘æœƒå¹«ä½ æ‰¾ä¸€éš»åŒæ¨£æƒ³å·æ‡¶çš„é­šã€‚é…å°æˆåŠŸå¾Œæœ‰ 5
              ç§’æ™‚é–“å¯ä»¥èŠå¤©ï¼Œå†æ±ºå®šè¦ä¸è¦ä¿ç•™é€™æ®µç·£åˆ†ã€‚
            </p>
            <button
              id="start-match-btn"
              class="w-full py-2.5 rounded-xl bg-emerald-500 text-slate-900 text-sm font-semibold hover:bg-emerald-400 disabled:bg-slate-600 disabled:text-slate-300"
            >
              é–‹å§‹æ‘¸é­šé…å°
            </button>
            <p
              id="match-hint"
              class="text-xs text-slate-400 mt-2 min-h-[1.5rem]"
            ></p>
          </div>

          <!-- å·²ä¿ç•™ç·£åˆ†å¡ç‰‡ -->
          <div class="bg-slate-800/70 rounded-2xl p-4 border border-slate-700">
            <h2 class="text-sm font-semibold text-slate-200 mb-1">
              å·²ä¿ç•™çš„æ‘¸é­šç·£åˆ†
            </h2>
            <p class="text-xs text-slate-400 mb-3">
              ç•¶é›™æ–¹éƒ½æŒ‰ä¸‹ã€Œä¿ç•™é€™æ®µç·£åˆ†ã€æ™‚ï¼Œä½ å€‘æœƒå‡ºç¾åœ¨é€™è£¡ã€‚é»ä¸€ä¸‹å°±èƒ½å†æ¬¡å·é–’èŠå¤©ã€‚
            </p>
            <div
              id="saved-list"
              class="space-y-2 max-h-60 overflow-y-auto text-sm"
            >
              <div class="text-slate-500 text-xs">
                ç›®å‰é‚„æ²’æœ‰ä¿ç•™çš„å°è©±ã€‚
              </div>
            </div>
          </div>
        </section>

        <!-- å³å´ï¼šèŠå¤©å®¤ -->
        <section>
          <div
            id="chat-card"
            class="bg-slate-800/70 rounded-2xl p-4 border border-slate-700 hidden flex flex-col h-full"
          >
            <!-- èŠå¤©å®¤æ¨™é¡Œåˆ— -->
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="text-xs text-slate-400 uppercase tracking-wide">
                  æ‘¸é­šé…å°èŠå¤©å®¤
                </div>
                <div
                  id="chat-title"
                  class="text-sm font-semibold text-slate-200"
                >
                  å°šæœªé…å°
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div
                  id="countdown-wrap"
                  class="px-2 py-1 rounded-full bg-slate-900/70 border border-amber-400/40 text-xs text-amber-300 hidden"
                >
                  â³ å‰©é¤˜
                  <span id="countdown" class="font-mono">5s</span>
                </div>
                <button
                  id="force-end-btn"
                  class="text-xs px-2.5 py-1 rounded-full border border-slate-600 text-slate-300 hover:bg-slate-700"
                >
                  çµæŸå°è©±
                </button>
              </div>
            </div>

            <!-- èŠå¤©è¨Šæ¯å€ -->
            <div
              id="messages"
              class="flex-1 bg-slate-900/60 rounded-xl p-3 text-sm space-y-2 overflow-y-auto"
            >
              <div class="text-xs text-slate-500 text-center">
                é…å°æˆåŠŸå¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä½ å€‘çš„å°è©±ã€‚
              </div>
            </div>

            <!-- è¼¸å…¥å€ -->
            <div class="mt-3">
              <div class="flex items-center gap-2">
                <input
                  id="chat-input"
                  type="text"
                  class="flex-1 px-3 py-2 rounded-xl bg-slate-900/80 border border-slate-700 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-400"
                  placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter æˆ–é»å³é‚Šé€å‡º"
                />
                <button
                  id="send-btn"
                  class="px-3 py-2 rounded-xl bg-emerald-500 text-slate-900 text-sm font-semibold hover:bg-emerald-400"
                >
                  é€å‡º
                </button>
              </div>
            </div>

            <!-- å€’æ•¸çµæŸå¾Œçš„é¸é … -->
            <div
              id="keep-actions"
              class="mt-3 pt-3 border-t border-slate-700 hidden"
            >
              <div class="text-xs text-slate-400 mb-2">
                æ™‚é–“åˆ°äº†ï¼Œè¦ä¿ç•™é€™æ®µæ‘¸é­šç·£åˆ†å—ï¼Ÿ
              </div>
              <div class="flex items-center gap-2">
                <button
                  id="keep-btn"
                  class="flex-1 py-2 rounded-xl bg-emerald-500 text-slate-900 text-sm font-semibold hover:bg-emerald-400"
                >
                  ä¿ç•™é€™æ®µç·£åˆ†
                </button>
                <button
                  id="end-btn"
                  class="flex-1 py-2 rounded-xl bg-slate-700 text-slate-100 text-sm hover:bg-slate-600"
                >
                  çµæŸä¸¦è¿”å›ä¸»ç•«é¢
                </button>
              </div>
              <div
                id="keep-hint"
                class="text-[11px] text-slate-500 mt-1 min-h-[1.25rem]"
              ></div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Firebase + ä¸»é‚è¼¯ -->
    <script type="module">
      // --- Firebase imports ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        collection,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      // --- Firebase configï¼ˆè·Ÿä½ å…¶ä»–é é¢ä¸€æ¨£ï¼‰ ---
      const firebaseConfig = {
        apiKey: "AIzaSyB4oaUyo3RWJnnLLN3CkiiJ8wimp_43kko",
        authDomain: "moyu-club.firebaseapp.com",
        projectId: "moyu-club",
        storageBucket: "moyu-club.firebasestorage.app",
        messagingSenderId: "178708686787",
        appId: "1:178708686787:web:be7c38dfe3d29a6695bf76",
        measurementId: "G-GPV3CMCZ0T",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM å¿«é€Ÿå–ç”¨ ---
      const nicknameText = document.getElementById("nickname-text");
      const langText = document.getElementById("lang-text");
      const statusText = document.getElementById("status-text");
      const matchPanel = document.getElementById("match-panel");
      const matchHint = document.getElementById("match-hint");
      const startMatchBtn = document.getElementById("start-match-btn");

      const chatCard = document.getElementById("chat-card");
      const chatTitle = document.getElementById("chat-title");
      const messagesEl = document.getElementById("messages");
      const countdownWrap = document.getElementById("countdown-wrap");
      const countdownEl = document.getElementById("countdown");
      const chatInput = document.getElementById("chat-input");
      const sendBtn = document.getElementById("send-btn");
      const forceEndBtn = document.getElementById("force-end-btn");

      const keepActions = document.getElementById("keep-actions");
      const keepBtn = document.getElementById("keep-btn");
      const endBtn = document.getElementById("end-btn");
      const keepHint = document.getElementById("keep-hint");
      const savedListEl = document.getElementById("saved-list");
      const logoutBtn = document.getElementById("logout-btn");

      // --- ç‹€æ…‹è®Šæ•¸ ---
      let socket = null;
      let currentUser = null;
      let currentUid = null;
      let currentNickname = "";
      let currentLang = localStorage.getItem("moyuLang") || "zh";

      let chatMode = null; // "random" or "saved"
      let chatLocked = false;
      let countdownTimer = null;
      let countdownRemaining = 5; // æ¸¬è©¦ç”¨ 5 ç§’

      let currentPartnerUid = null;
      let currentPartnerNickname = null;
      let currentRoomId = null;

      // --- ç°¡å–® i18nï¼ˆå…ˆä¿ç•™åŸºç¤ï¼Œä¹‹å¾Œå¯æ“´å……ï¼‰ ---
      const i18n = {
        zh: {
          startMatching: "é–‹å§‹æ‘¸é­šé…å°",
          matching: "ğŸ£ æ­£åœ¨å°‹æ‰¾å¦ä¸€éš»é­š...",
          idle: "ä½ ç¾åœ¨å¯ä»¥é–‹å§‹æ‘¸é­šé…å°ã€‚",
          chatTitleRandom: (name) => `æ­£åœ¨å’Œ ${name} èŠå¤©`,
          chatTitleSaved: (name) => `å·²ä¿ç•™ç·£åˆ†ï¼š${name}`,
          chatEnded: "å°è©±å·²çµæŸï¼Œå¯ä»¥é‡æ–°é…å°æˆ–æ‰¾å·²ä¿ç•™ç·£åˆ†ã€‚",
          timeUp: "æ™‚é–“åˆ°äº†ï¼Œè«‹é¸æ“‡æ˜¯å¦è¦ä¿ç•™é€™æ®µç·£åˆ†ã€‚",
          keepSuccess: "é€™æ®µç·£åˆ†å·²è¢«ä¿ç•™ï¼Œå¯ä»¥ç¹¼çºŒèŠå¤© âœ¨",
          partnerWantsKeep: "å°æ–¹æƒ³ä¿ç•™é€™æ®µç·£åˆ†ï¼Œå¦‚æœä½ ä¹ŸæŒ‰ä¸‹ï¼Œå°±æœƒä¸€èµ·è¢«æ”¶è—ã€‚",
        },
        en: {
          startMatching: "Start random match",
          matching: "ğŸ£ Searching for another fish...",
          idle: "You can start a new match now.",
          chatTitleRandom: (name) => `Chatting with ${name}`,
          chatTitleSaved: (name) => `Saved connection: ${name}`,
          chatEnded: "Chat ended. You can start a new match or open a saved one.",
          timeUp: "Time's up. Decide whether to keep this connection.",
          keepSuccess: "Connection saved. You can keep chatting âœ¨",
          partnerWantsKeep:
            "Your partner wants to keep this connection. Tap keep to save it too.",
        },
      };

      function t(key, ...args) {
        const pack = i18n[currentLang] || i18n["zh"];
        const val = pack[key];
        if (typeof val === "function") return val(...args);
        return val ?? key;
      }

      function applyLangTexts() {
        startMatchBtn.textContent = t("startMatching");
        langText.textContent =
          currentLang === "en" ? "Language: English" : "èªè¨€ï¼šä¸­æ–‡ï¼ˆä¾å¸³æˆ¶è¨­å®šï¼‰";
      }

      // --- UI helper functions ---

      function setStatus(msg) {
        statusText.textContent = msg;
      }

      function showMatchPanel() {
        matchPanel.classList.remove("opacity-50", "pointer-events-none");
        startMatchBtn.disabled = false;
      }

      function disableMatchPanelWhileChat() {
        matchPanel.classList.add("opacity-50", "pointer-events-none");
        startMatchBtn.disabled = true;
      }

      function showChatCard() {
        chatCard.classList.remove("hidden");
      }

      function hideChatCard() {
        chatCard.classList.add("hidden");
      }

      function showCountdown() {
        countdownWrap.classList.remove("hidden");
      }

      function hideCountdown() {
        countdownWrap.classList.add("hidden");
      }

      function updateCountdownUI() {
        if (!countdownEl) return;
        countdownEl.textContent = `${countdownRemaining}s`;
      }

      function startCountdown() {
        stopCountdown();
        countdownRemaining = 5; // ä¹‹å¾Œè¦æ”¹æˆ 300 ç§’åªè¦é€™è£¡èª¿æ•´
        chatLocked = false;
        showCountdown();
        updateCountdownUI();

        countdownTimer = setInterval(() => {
          countdownRemaining -= 1;
          if (countdownRemaining <= 0) {
            stopCountdown();
            chatLocked = true;
            hideCountdown();
            showKeepActions();
            appendSystemMessage(t("timeUp"));
          } else {
            updateCountdownUI();
          }
        }, 1000);
      }

      function stopCountdown() {
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      }

      function showKeepActions() {
        keepActions.classList.remove("hidden");
        keepHint.textContent = "";
      }

      function hideKeepActions() {
        keepActions.classList.add("hidden");
        keepHint.textContent = "";
      }

      function clearMessages() {
        messagesEl.innerHTML = "";
      }

      function appendSystemMessage(text) {
        const div = document.createElement("div");
        div.className = "text-center text-[11px] text-slate-400 my-1";
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function appendChatMessage(text, isMe, fromName) {
        if (!text) return;

        const wrap = document.createElement("div");
        wrap.className = `flex ${isMe ? "justify-end" : "justify-start"}`;

        const bubble = document.createElement("div");
        bubble.className = `px-3 py-2 rounded-lg max-w-xs break-words shadow ${
          isMe
            ? "bg-emerald-500 text-slate-900"
            : "bg-slate-700 text-slate-100"
        }`;

        if (!isMe) {
          const nameSpan = document.createElement("div");
          nameSpan.className = "text-[11px] text-slate-300 mb-0.5";
          nameSpan.textContent = fromName || "å°æ–¹";
          bubble.appendChild(nameSpan);
        }

        const textSpan = document.createElement("div");
        textSpan.textContent = text;
        bubble.appendChild(textSpan);

        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function updateChatTitle() {
        if (!currentPartnerNickname) {
          chatTitle.textContent = "å°šæœªé…å°";
          return;
        }
        if (chatMode === "saved") {
          chatTitle.textContent = t("chatTitleSaved", currentPartnerNickname);
        } else {
          chatTitle.textContent = t("chatTitleRandom", currentPartnerNickname);
        }
      }

      function resetChatState() {
        stopCountdown();
        hideCountdown();
        hideKeepActions();
        chatLocked = false;
        chatMode = null;
        currentPartnerUid = null;
        currentPartnerNickname = null;
        currentRoomId = null;
        clearMessages();
        chatInput.value = "";
        updateChatTitle();
      }

      function backToHomeIdle() {
        resetChatState();
        hideChatCard();
        showMatchPanel();
        setStatus(t("idle"));
        matchHint.textContent = "";
      }

      // --- Firestoreï¼šå„²å­˜ / è¼‰å…¥å·²ä¿ç•™ç·£åˆ† ---

      async function saveRoomToFirestore(
        roomId,
        myUid,
        partnerUid,
        partnerNickname
      ) {
        if (!roomId || !myUid || !partnerUid) return;

        const createdAt = new Date().toISOString();

        // rooms collection
        await setDoc(
          doc(db, "rooms", roomId),
          {
            participants: [myUid, partnerUid],
            createdAt,
          },
          { merge: true }
        );

        // è‡ªå·±é€™é‚Šçš„ savedRooms
        await setDoc(
          doc(db, "users", myUid, "savedRooms", roomId),
          {
            roomId,
            partnerUid,
            partnerNickname,
            createdAt,
          },
          { merge: true }
        );

        // å°æ–¹é‚£é‚Šçš„ savedRooms
        await setDoc(
          doc(db, "users", partnerUid, "savedRooms", roomId),
          {
            roomId,
            partnerUid: myUid,
            partnerNickname: currentNickname,
            createdAt,
          },
          { merge: true }
        );
      }

      async function loadSavedRooms() {
        if (!currentUid) return;
        savedListEl.innerHTML =
          '<div class="text-xs text-slate-500">è¼‰å…¥ä¸­...</div>';

        const colRef = collection(db, "users", currentUid, "savedRooms");
        const snap = await getDocs(colRef);

        if (snap.empty) {
          savedListEl.innerHTML =
            '<div class="text-xs text-slate-500">ç›®å‰é‚„æ²’æœ‰ä¿ç•™çš„å°è©±ã€‚</div>';
          return;
        }

        let html = "";
        const rows = [];

        snap.forEach((docSnap) => {
          const data = docSnap.data();
          rows.push({
            roomId: data.roomId,
            partnerUid: data.partnerUid,
            partnerNickname: data.partnerNickname || "æ‘¸é­šå¤¥ä¼´",
            createdAt: data.createdAt,
          });
        });

        // ç°¡å–®ä¾æ™‚é–“æ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
        rows.sort((a, b) =>
          (b.createdAt || "").localeCompare(a.createdAt || "")
        );

        rows.forEach((r) => {
          html += `
            <button
              class="w-full text-left px-3 py-2 rounded-xl bg-slate-900/60 hover:bg-slate-800 flex items-center justify-between gap-2"
              data-room-id="${r.roomId}"
              data-partner-uid="${r.partnerUid}"
              data-partner-nickname="${r.partnerNickname}"
            >
              <div>
                <div class="text-sm text-slate-100">${r.partnerNickname}</div>
                <div class="text-[11px] text-slate-500">
                  æˆ¿é–“ ID: ${r.roomId.slice(0, 8)}...
                </div>
              </div>
              <div class="text-[11px] text-emerald-300">
                å†æ¬¡æ‘¸é­š
              </div>
            </button>
          `;
        });

        savedListEl.innerHTML = html;

        // ç¶å®š click äº‹ä»¶
        savedListEl.querySelectorAll("button[data-room-id]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const roomId = btn.getAttribute("data-room-id");
            const partnerNickname = btn.getAttribute(
              "data-partner-nickname"
            );
            openSavedChat(roomId, partnerNickname);
          });
        });
      }

      function openSavedChat(roomId, partnerNickname) {
        if (!socket) return;

        chatMode = "saved";
        chatLocked = false;
        currentRoomId = roomId;
        currentPartnerNickname = partnerNickname || "æ‘¸é­šå¤¥ä¼´";

        disableMatchPanelWhileChat();
        showChatCard();
        hideCountdown();
        hideKeepActions();
        clearMessages();
        updateChatTitle();
        appendSystemMessage(
          `å·²é‡æ–°é€£ç·š ${currentPartnerNickname}ï¼Œé€™æ˜¯ä½ å€‘ä¿ç•™çš„æ‘¸é­šç·£åˆ†ã€‚`
        );

        socket.emit("join-saved-room", { roomId });
      }

      // --- Socket.io ç›¸é—œ ---

      function setupSocketHandlers() {
        if (!socket) return;

        socket.on("connect", () => {
          console.log("ğŸ”Œ socket é€£ç·šæˆåŠŸ", socket.id);
        });

        socket.on("status", (text) => {
          setStatus(text);
        });

        socket.on("match", (payload) => {
          chatMode = "random";
          chatLocked = false;
          currentPartnerNickname =
            payload.partnerNickname || "æ‘¸é­šå¤¥ä¼´";
          currentPartnerUid = payload.partnerUid || null;
          currentRoomId = null;

          disableMatchPanelWhileChat();
          showChatCard();
          clearMessages();
          updateChatTitle();
          appendSystemMessage(payload.message || "é…å°æˆåŠŸï¼");
          matchHint.textContent = "";
          setStatus("é…å°æˆåŠŸï¼Œé–‹å§‹èŠå¤©å§ï¼");
          startCountdown();
        });

        socket.on("chat", (msg) => {
          const text = msg.text || msg.message || "";
          const fromName = msg.from || "å°æ–¹";
          const isMe = fromName === currentNickname;
          appendChatMessage(text, isMe, fromName);
        });

        socket.on("show-keep-option", () => {
          // å°æ–¹å…ˆæŒ‰äº†ã€Œä¿ç•™ã€ï¼Œæˆ‘å€‘é€™é‚Šæå‰é¡¯ç¤ºé¸é …ï¼‹æç¤º
          showKeepActions();
          keepHint.textContent = t("partnerWantsKeep");
        });

        socket.on("keep-confirmed", async ({ partnerUid, partnerNickname }) => {
          // å…©é‚Šéƒ½æŒ‰ä¸‹ä¿ç•™
          currentPartnerUid = partnerUid;
          currentPartnerNickname =
            partnerNickname || currentPartnerNickname || "æ‘¸é­šå¤¥ä¼´";

          const uidA = currentUid;
          const uidB = partnerUid || currentUid;
          const roomId = [uidA, uidB].sort().join("_");

          chatMode = "saved";
          chatLocked = false;
          currentRoomId = roomId;

          stopCountdown();
          hideCountdown();
          hideKeepActions();
          updateChatTitle();
          appendSystemMessage(t("keepSuccess"));

          // åŠ å…¥æˆ¿é–“ï¼ˆå¾Œç«¯æœƒæŠŠ socket.currentRoomId è¨­å®šå¥½ï¼‰
          socket.emit("join-saved-room", { roomId });

          // Firestore å¯«å…¥æˆ¿é–“è³‡æ–™èˆ‡ savedRooms
          try {
            await saveRoomToFirestore(
              roomId,
              currentUid,
              currentPartnerUid,
              currentPartnerNickname
            );
            await loadSavedRooms();
          } catch (err) {
            console.error("å„²å­˜ä¿ç•™ç·£åˆ†å¤±æ•—ï¼š", err);
          }
        });

        socket.on("saved-room-joined", ({ roomId }) => {
          console.log("ğŸ§µ å·²åŠ å…¥ä¿ç•™æˆ¿é–“", roomId);
        });

        socket.on("chat-end", ({ reason } = {}) => {
          console.log("ğŸ’¨ chat-endï¼š", reason);
          appendSystemMessage(t("chatEnded"));
          backToHomeIdle();
        });
      }

      function sendMessage() {
        if (chatLocked) return;

        const text = chatInput.value.trim();
        if (!text) return;

        socket.emit("chat", {
          text,
          from: currentNickname,
        });

        appendChatMessage(text, true, currentNickname);
        chatInput.value = "";
      }

      // --- äº‹ä»¶ç¶å®š ---

      startMatchBtn.addEventListener("click", () => {
        if (!socket) return;
        matchHint.textContent = t("matching");
        setStatus(t("matching"));
        hideChatCard();
        socket.emit("start-matching");
      });

      sendBtn.addEventListener("click", sendMessage);

      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      forceEndBtn.addEventListener("click", () => {
        if (!socket) return;
        socket.emit("end-chat");
      });

      endBtn.addEventListener("click", () => {
        if (!socket) return;
        socket.emit("end-chat");
      });

      keepBtn.addEventListener("click", () => {
        if (!socket) return;
        keepHint.textContent = "å·²é€å‡ºä¿ç•™è«‹æ±‚ï¼Œç­‰å¾…å°æ–¹é¸æ“‡...";
        socket.emit("keep-request");
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
        } catch (e) {
          console.error(e);
        } finally {
          localStorage.removeItem("moyuUid");
          localStorage.removeItem("moyuNickname");
          window.location.href = "login.html";
        }
      });

      // --- Firebase Authï¼šç¢ºèªç™»å…¥ç‹€æ…‹ï¼Œè¼‰å…¥æš±ç¨± & å»ºç«‹ socket ---

      applyLangTexts();
      setStatus("æ­£åœ¨æª¢æŸ¥ç™»å…¥ç‹€æ…‹...");

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        currentUser = user;
        currentUid = user.uid;

        try {
          const userSnap = await getDoc(doc(db, "users", currentUid));
          if (userSnap.exists()) {
            const data = userSnap.data();
            currentNickname = data.nickname || "åŒ¿åé­š";
            if (data.lang && (data.lang === "zh" || data.lang === "en")) {
              currentLang = data.lang;
              localStorage.setItem("moyuLang", currentLang);
              applyLangTexts();
            }
          } else {
            currentNickname = "åŒ¿åé­š";
          }
        } catch (err) {
          console.error("è®€å–ä½¿ç”¨è€…æš±ç¨±å¤±æ•—ï¼š", err);
          currentNickname = "åŒ¿åé­š";
        }

        nicknameText.textContent = currentNickname;
        localStorage.setItem("moyuUid", currentUid);
        localStorage.setItem("moyuNickname", currentNickname);

        setStatus(t("idle"));

        // å»ºç«‹ socket é€£ç·š
        socket = io({
          query: {
            uid: currentUid,
            nickname: currentNickname,
          },
        });

        setupSocketHandlers();

        // è¼‰å…¥å·²ä¿ç•™ç·£åˆ†
        await loadSavedRooms();
      });
    </script>
  </body>
</html>
