<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MÅyu Club ğŸ </title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, #d6f0ff, #a0d8ef);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    #nickname-section, #chat-section {
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 20px;
      width: 90%;
      max-width: 480px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      margin: 5px;
    }
    button {
      background-color: #00a0e9;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #007bbd; }
    #chat-box {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 10px;
      text-align: left;
      margin-bottom: 10px;
    }
    .system-msg {
      color: #555;
      font-style: italic;
      text-align: center;
      margin: 8px 0;
    }
    .keep-buttons button {
      background-color: #ffb6b9;
      margin: 5px;
    }
    .keep-buttons button:first-child {
      background-color: #a3d977;
    }
  </style>
</head>

<body>
  <!-- æš±ç¨±è¨­å®šé  -->
  <div id="nickname-section">
    <h2>ğŸŸ æ­¡è¿ä¾†åˆ° MÅyu Club</h2>
    <p>è«‹è¼¸å…¥ä½ çš„æš±ç¨±æˆ–ç›´æ¥é–‹å§‹æ‘¸é­š</p>
    <input id="nickname-input" placeholder="è¼¸å…¥æš±ç¨±..." />
    <br />
    <button id="start-btn">é–‹å§‹æ‘¸é­š</button>
  </div>

  <!-- èŠå¤©ä¸»ç•«é¢ -->
  <div id="chat-section" style="display:none;">
    <h2 id="status">ğŸ£ é…å°ä¸­...</h2>
    <div id="timer">â³ 3 ç§’</div>
    <div id="chat-box"></div>
    <input id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." />
    <button id="send-btn">é€å‡º</button>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const nicknameSection = document.getElementById("nickname-section");
    const chatSection = document.getElementById("chat-section");
    const chatBox = document.getElementById("chat-box");
    const msgInput = document.getElementById("msg-input");
    const sendBtn = document.getElementById("send-btn");
    const timerDisplay = document.getElementById("timer");
    const statusDisplay = document.getElementById("status");

    let socket, timer;
    let countdown = 3;
    let inMatch = false;

    document.getElementById("start-btn").addEventListener("click", () => {
      const nickname = document.getElementById("nickname-input").value || "åŒ¿åé­š";
      nicknameSection.style.display = "none";
      chatSection.style.display = "block";
      startSocket(nickname);
    });

    function startSocket(nickname) {
      socket = io({ query: { nickname } });

      socket.on("connect", () => {
        statusDisplay.innerText = "ğŸ£ æ­£åœ¨å°‹æ‰¾å¦ä¸€éš»æ‘¸é­šçš„é­š...";
      });

      socket.on("status", (msg) => {
        statusDisplay.innerText = msg;
      });

      socket.on("match", (msg) => {
        inMatch = true;
        chatBox.innerHTML += `<div class="system-msg">${msg}</div>`;
        startCountdown();
      });

      socket.on("chat", (msg) => {
        chatBox.innerHTML += `<div>${msg}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      // é¡¯ç¤ºå°æ–¹æƒ³ä¿ç•™
      socket.on("show-keep-option", () => {
        showKeepOption();
      });

      // é›™æ–¹éƒ½æŒ‰ä¿ç•™
      socket.on("keep-success", () => {
        clearInterval(timer);
        chatBox.innerHTML += `<div class="system-msg">ğŸ’« ä½ å€‘å¾—åˆ°äº†ç·£åˆ†ï¼å¯è‡ªç”±èŠå¤©ï¼Œæ™‚é–“ç„¡é™åˆ¶ã€‚</div>`;
        timerDisplay.innerText = "ğŸ’ ç·£åˆ†æ¨¡å¼";
      });

      // å°æ–¹æˆ–è‡ªå·±çµæŸ
      socket.on("chat-end", () => {
        chatBox.innerHTML += `<div class="system-msg">ğŸš ç·£åˆ†æœªæˆï¼Œå›åˆ°å¤§æµ·é‡æ–°æ‘¸é­š...</div>`;
        endChatAndReset();
      });
    }

    // å€’æ•¸è¨ˆæ™‚
    function startCountdown() {
      clearInterval(timer);
      countdown = 3;
      timer = setInterval(() => {
        countdown--;
        timerDisplay.innerText = `â³ ${countdown} ç§’`;
        if (countdown <= 0) {
          clearInterval(timer);
          showKeepOption();
        }
      }, 1000);
    }

    // é¡¯ç¤ºä¿ç•™é¸é …
    function showKeepOption() {
      if (!inMatch) return;
      chatBox.innerHTML += `
        <div class="system-msg">æ™‚é–“åˆ°äº†ï¼Œè¦ä¿ç•™é€™æ®µå°è©±å—ï¼Ÿ</div>
        <div class="keep-buttons">
          <button id="keepYes">ğŸ’¾ ä¿ç•™å°è©±</button>
          <button id="keepNo">ğŸšª çµæŸå°è©±</button>
        </div>
      `;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById("keepYes").onclick = () => {
        socket.emit("keep-request");
        document.querySelector(".keep-buttons").remove();
        chatBox.innerHTML += `<div class="system-msg">ğŸ“¨ å·²ç™¼å‡ºä¿ç•™è«‹æ±‚ï¼Œç­‰å¾…å°æ–¹ç¢ºèª...</div>`;
      };

      document.getElementById("keepNo").onclick = () => {
        socket.emit("end-chat");
        endChatAndReset();
      };
    }

    // çµæŸèŠå¤©ä¸¦è¿”å›ä¸»ç•«é¢
    function endChatAndReset() {
      inMatch = false;
      setTimeout(() => {
        chatSection.style.display = "none";
        nicknameSection.style.display = "block";
        chatBox.innerHTML = "";
        msgInput.value = "";
        timerDisplay.innerText = "â³";
      }, 2000);
    }

    // ç™¼é€è¨Šæ¯
    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const msg = msgInput.value.trim();
      if (!msg) return;
      socket.emit("chat", msg);
      msgInput.value = "";
    }
  </script>
</body>
</html>
